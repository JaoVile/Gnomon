// prisma/schema.prisma

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ==========================================
// 1. User Accounts
// ==========================================
model Admstaff {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  name      String
  password  String
  role      Role     @default(STAFF)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  favorites UserFavorite[]
  history   RouteHistory[]

  @@map("admstaff") // The table name in the database
}

enum Role {
  ADMIN
  STAFF
}

// ==========================================
// 2. Maps & Points of Interest
// ==========================================
model Map {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  imageUrl  String
  
  // Relations
  locals    Local[]
  graphNodes GraphNode[]

  @@map("maps")
}

model Local {
  id          Int       @id @default(autoincrement())
  name        String
  description String?
  type        LocalType // A category from the list below
  
  // Relations
  mapId       Int
  map         Map       @relation(fields: [mapId], references: [id])
  graphNode   GraphNode?

  @@map("locals")
}

// Enum based on the categories from your nodes.json
enum LocalType {
  ENTRANCE
  OFFICE
  BATHROOM
  PATIO
  LIBRARY
  LAB
  AUDITORIUM
  CANTEEN
  STAFF_ROOM
}

// ==========================================
// 3. Navigation Graph (Replaces JSON files)
// ==========================================
model GraphNode {
  id        Int    @id @default(autoincrement())
  x         Float
  y         Float
  
  // Relations
  mapId     Int
  map       Map    @relation(fields: [mapId], references: [id])
  localId   Int?   @unique
  local     Local? @relation(fields: [localId], references: [id])
  edgesFrom GraphEdge[] @relation("EdgeFrom")
  edgesTo   GraphEdge[] @relation("EdgeTo")

  @@map("graph_nodes")
}

model GraphEdge {
  id         Int     @id @default(autoincrement())
  weight     Float
  
  // Relations
  fromNodeId Int
  fromNode   GraphNode @relation("EdgeFrom", fields: [fromNodeId], references: [id])
  toNodeId   Int
  toNode     GraphNode @relation("EdgeTo", fields: [toNodeId], references: [id])

  @@unique([fromNodeId, toNodeId])
  @@map("graph_edges")
}

// ==========================================
// 4. USER-SPECIFIC DATA (Optional but Recommended)
// ==========================================
model UserFavorite {
  id         Int      @id @default(autoincrement())
  name       String
  userId     Int
  user       Admstaff @relation(fields: [userId], references: [id])
  fromNodeId Int
  toNodeId   Int
  createdAt  DateTime @default(now())
  
  @@map("user_favorites")
}

model RouteHistory {
  id         Int      @id @default(autoincrement())
  userId     Int
  user       Admstaff @relation(fields: [userId], references: [id])
  fromNodeId Int
  toNodeId   Int
  createdAt  DateTime @default(now())

  @@map("route_history")
}